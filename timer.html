<!DOCTYPE html>
<html>

<head>
    <title>wnr</title>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimal-ui" />
    <script>
        if (typeof module === 'object') {
            window.module = module; module = undefined;
        }
    </script>
    <!-- solve the electron-jquery conflict, style changed due to a vscode problem -->
    <!-- solve the electron-jquery conflict -->
    <script src="res/lib/jquery-3.3.1.min.js"></script>
    <script src="res/lib/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="res/lib/bootstrap.min.css" />
    <script src="res/lib/all.js"></script>
    <script src="res/lib/v4-shims.js"></script><!-- font-awesome 5 use as 4 -->
    <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>
    <script src="supporter.js"></script>
    <div class="d-flex mx-auto justify-content-center align-items-center text-dark" id="main">
        <div id="time-bar" class="text-muted"></div>
        <div id="time-bar-macos" class="text-muted"></div><!-- time-bar for systems -->
        <div id="controller">
            <a href="javascript:getHelp('guide/1-basic-usage')" class="small work"><i class="fa fa-question"
                    id="helper"></i></a>&nbsp;&nbsp;
            <a href="javascript:call('window-hide')" class="small work" id="win-hider"><i class="fa fa-sort-desc fa-fw"
                    id="window-hide"></i></a><span id="no-use-space">&nbsp;&nbsp;</span>
            <a href="javascript:call('window-minimize')" class="small work"><i class="fa fa-minus fa-fw"
                    id="window-minimize"></i></a>&nbsp;&nbsp;
            <a href="javascript:call('window-close-chk')" class="small work"><i class="fa fa-times fa-fw"
                    id="exit"></i></a>&nbsp;&nbsp;
            <script>
                $('#helper').attr('title', i18n.__('helper'));
                $('#window-hide').attr('title', i18n.__('window-hide'));
                $('#window-minimize').attr('title', i18n.__('window-minimize'));
                $('#exit').attr('title', i18n.__('exit'));
            </script>
        </div>
        <div id="timer" class="justify-content-center align-content-center text-center">
            <div id="title" class="text-center h4"></div>
            <div id="note" class="text-center small text-muted"></div><br />
            <div id="work-rest" class="text-center work">
                <script>document.write(i18n.__('working'));</script>
            </div><br />
            <div id="now-timing" class="text-center h1 work"></div><br />
            <div class="text-center lead"><a id="stopper" href="javascript:stopper()" class="text-muted"><i
                        class="fa fa-pause"></i></a></div><br />
            <div class="text-center text-muted" id="more-options"><a href="index.html" class="text-muted"><i
                        class="fa fa-angle-left" id="back-index"></i></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a
                    href="javascript:skipper()" class="text-muted"><i class="fa fa-angle-double-right"
                        id="skipper"></i></a></div><br />
            <div class="text-center lead" id="backer"><a href="index.html" class="text-muted"><i
                        class="fa fa-angle-left" id="backindex2"></i></a></div>
            <script>
                $('#back-index').attr('title', i18n.__('back-index'));
                $('#backindex2').attr('title', i18n.__('back-index'));
                $('#backer').css('display', 'none');
                $('#skipper').attr('title', i18n.__('skipper'));
                if (process.platform == "darwin") $("#controller").css("display", "none");
            </script>
        </div>
    </div><!-- for things with 'work' mark, when it's resting, the color should be changed -->
    <div id="bottom-bar">&nbsp;</div>
    <script>
        if (process.platform == "darwin") {
            $("#win-hider").css("display", "none");
            $("#no-use-space").css("display", "none");
        }
        store.set('just-launched', false);

        function keydownOnError(e) {
            var currKey = 0, e = e || event;
            if (e.keyCode == 13) {
                window.location.href = "index.html";
            }
        }
        var $_GET = (function () {
            var url = window.document.location.href.toString();
            var u = url.split("?");
            if (typeof (u[1]) == "string") {
                u = u[1].split("&");
                var get = {};
                for (var i in u) {
                    var j = u[i].split("=");
                    get[j[0]] = j[1];
                }
                return get;
            } else {
                return {};
            }
        })();

        var title = decodeURI($_GET['title']);
        var note = decodeURI($_GET['note']);
        var workTime = decodeURI($_GET['work-time']) * 60000;
        var restTime = decodeURI($_GET['rest-time']) * 60000;//use ms
        var loop = decodeURI($_GET['loop']);
        var h = i18n.__('h');
        var min = i18n.__('min');
        var s = i18n.__('s');
        var player = document.createElement("audio");//alert player
        if (!loop || workTime <= 60000 || restTime <= 60000) {//use ms for 1s
            $("#timer").html("<p class='text-center text-muted lead' id='timer-error'>" + i18n.__('not-enough') + "<br/><a href='index.html' class='work'>" + i18n.__('back') + "</a></p>");
            $("#timer").css("width", "75%");
            isTimerWindow(false);
            document.onkeydown = keydownOnError;
        } else if (workTime / 60000 > 1440 || restTime / 60000 > 1440 || (workTime + restTime) * loop > 86400000) {
            $("#timer").html("<p class='text-center text-muted lead' id='timer-error'>" + i18n.__('too-long') + "<br/><a href='index.html' class='work'>" + i18n.__('back') + "</a></p>");
            $("#timer").css("width", "75%");
            isTimerWindow(false);
            document.onkeydown = keydownOnError;
        } else {
            isTimerWindow(true);
            if (title) $("#title").html(title);
            if (note) $("#note").html(note);
            if (store.get('fullscreen-work')) {
                ipc.send('focus-first');
                $("#controller").css("display", "none");
                $("#more-options").css("display", "none");
                $("#now-timing").addClass("display-1");
                $("#now-timing").removeClass("h1");
            }

            var startTime, int, tempVariable, nowTime, timeGot, seconds, minutes, hours, method = 1, times = 0, isClockWorking = 1, moreThanOneMin = 1;//method: 1-work / 2-rest, times: time-reset times, moreThanOneMin: more than 1 min left
            startTime = new Date().getTime();
            int = self.setInterval(clock, 100);

            ipc.on('start-or-stop', function () {
                stopper();
            })

            function stopper() {
                if (isClockWorking) {
                    window.clearInterval(int);
                    $("#stopper").html("<i class='fa fa-play' aria-hidden='true'></i>");
                    isClockWorking = 0;//to stop
                } else {
                    if (method == 1) startTime = new Date().getTime() - (workTime - hours * 3600000 - minutes * 60000 - seconds * 1000);
                    else startTime = new Date().getTime() - (restTime - hours * 3600000 - minutes * 60000 - seconds * 1000);
                    int = self.setInterval(clock, 100);
                    $("#stopper").html("<i class='fa fa-pause' aria-hidden='true'></i>");
                    isClockWorking = 1;//to restart
                }
            }

            function warningGiver(isend) {
                if (store.get("sound") == true || store.get("sound") == undefined) {
                    if (isend != 0) {
                        player.src = path.join(__dirname, "\\res\\sound\\timeend.wav");
                    } else {
                        player.src = path.join(__dirname, "\\res\\sound\\allend.wav");
                    }
                    player.loop = true;
                    player.play();
                }//different sound for different circumstances
                if (isend == 0) ipc.send('warning-giver-all-task-end');
                else {
                    if (isend == 1) ipc.send('warning-giver-workend');
                    else ipc.send('warning-giver-restend');
                    var tempVariable = setTimeout(stopper, 500);
                    ipc.once('warning-closed', function () {
                        player.loop = false;
                        player.pause();
                        stopper();
                    });
                }
            }

            function themeChanger() {
                if (method == 1) {
                    $(".work").addClass("rest");
                    $(".work").removeClass("work");
                    $("#work-rest").html(i18n.__('resting'));
                    $("#bottom-bar").css("background-color", "#5490eac2");
                    method = 2;
                    if (store.get("fullscreen") == true) {
                        $("#controller").css("display", "none");
                        $("#more-options").css("display", "none");
                        $("#now-timing").addClass("display-1");
                        $("#now-timing").removeClass("h1");
                    } else if (store.get("fullscreen-work") == true) {
                        if (process.platform != "darwin") $("#controller").css("display", "block");
                        $("#more-options").css("display", "block");
                        $("#now-timing").removeClass("display-1");
                        $("#now-timing").addClass("h1");
                    }
                    warningGiver(1);
                } else {
                    $(".rest").addClass("work");
                    $(".rest").removeClass("rest");
                    $("#work-rest").html(i18n.__('working'));
                    $("#bottom-bar").css("background-color", "#ea5454c2");
                    method = 1;
                    if (process.platform != "darwin") $("#controller").css("display", "block");
                    if (store.get("fullscreen-work") == true) {
                        $("#controller").css("display", "none");
                        $("#more-options").css("display", "none");
                        $("#now-timing").addClass("display-1");
                        $("#now-timing").removeClass("h1");
                    } else if (store.get("fullscreen") == true) {
                        $("#more-options").css("display", "block");
                        $("#now-timing").removeClass("display-1");
                        $("#now-timing").addClass("h1");
                    }
                    warningGiver(2);
                }
            }

            function ender() {
                window.clearInterval(int);
                $("#work-rest").text("");
                $("#now-timing").text(i18n.__('ended'));
                isClockWorking = 0;
                $("#stopper").text("");
                ipc.send("progress-bar-set", 2);//the progress-bar-set is using (1-message), so when message is 2, the answer is -1
                if (process.platform != "darwin") $("#controller").css("display", "block");
                $("#backer").css("display", "block");
                $("#more-options").css("display", "none");
                if (store.get("fullscreen") == true) {
                    $("#now-timing").removeClass("display-1");
                    $("#now-timing").addClass("h1");
                }
                warningGiver(0);
            }

            function skipper() {
                times++;
                if (times < loop * 2) {
                    startTime = new Date().getTime();
                    themeChanger();
                } else if (times == loop * 2) {
                    ender();
                }
            }

            function positionCover(str) {//cover the positions of '0'
                var num;
                str >= 10 ? num = str : num = "0" + str;
                return num;
            }

            function clock() {
                nowTime = new Date();
                tempVariable = nowTime.getTime();
                if (method == 1) seconds = parseInt((workTime - tempVariable + startTime) / 1000);
                else seconds = parseInt((restTime - tempVariable + startTime) / 1000);
                if (seconds > 0) {
                    if (method == 1) {
                        ipc.send("progress-bar-set", ((seconds / workTime) * 1000).toFixed(2));
                        $("#bottom-bar").css("width", (seconds / workTime) * 100000 + "%");
                    } else {
                        ipc.send("progress-bar-set", ((seconds / restTime) * 1000).toFixed(2));
                        $("#bottom-bar").css("width", (seconds / restTime) * 100000 + "%");
                    }
                    hours = parseInt(seconds / 3600);
                    minutes = parseInt((seconds - hours * 3600) / 60);
                    seconds = seconds - hours * 3600 - minutes * 60;
                    $("#now-timing").text(hours + h + minutes + min + seconds + s);
                    timeGot = positionCover(nowTime.getHours()) + ":" + positionCover(nowTime.getMinutes());
                    if (process.platform != "darwin") $("#time-bar").html(timeGot);
                    else $("#time-bar-macos").html(timeGot);//display the current time
                    if (minutes == 0 && moreThanOneMin && hours == 0) {
                        if (store.get("onemintip") != false) ipc.send("only-one-min-left");
                        moreThanOneMin = 0;
                    }
                } else {
                    skipper();
                }
            }
        }
    </script>
    <script src="renderer.js"></script>
</body>

</html>